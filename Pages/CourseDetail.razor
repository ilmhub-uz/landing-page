@page "/coursedetail/{CourseTitle}"
@inject NavigationManager NavigationManager
@using System.Globalization
@using Microsoft.AspNetCore.WebUtilities
@using System.Text
@inject IJSRuntime jsRuntime
<main>
<section class="bg-light py-0">
	<div class="container">
		<div class="row py-4">
			<div class="col-lg-8">
				<div class="col md-6">
				<h6 class="mb-3 font-base bg-primary text-white py-2 px-4 rounded-2 d-inline-block">@course.Tag</h6>
				@* <button class="btn btn-outline-primary mx-9 " onclick="history.back()">Go Back</button> *@
				</div>
				<!-- Title -->
				<h2>@course.Title</h2>
				
			</div>
		</div>
	</div>
</section>
<!-- =======================
Page intro END -->
<!-- =======================
Page content START -->
<section class="pb-0 py-lg-5">
	<div class="container">
		<div class="row">
			<!-- Main content START -->
			<div class="col-lg-8">
				<div class="card shadow rounded-2 p-0">
					<!-- Tabs START -->
					<div class="card-header border-bottom px-4 py-3">
						<ul class="nav nav-pills nav-tabs-line py-0" id="course-pills-tab" role="tablist">
							<!-- Tab item -->
							<li class="nav-item me-2 me-sm-4" role="presentation">
								<button class="nav-link mb-2 mb-md-0 @tabs[0].ToString()" @onclick='()=>ChangeQueryTab("")' id="course-pills-tab-1" data-bs-toggle="pill" data-bs-target="#course-pills-1" type="button" role="tab" aria-controls="course-pills-1" aria-selected="false">Ma'lumot</button>
							</li>
							<!-- Tab item -->
							<li class="nav-item me-2 me-sm-4" role="presentation">
								<button class="nav-link mb-2 mb-md-0 @tabs[1].ToString()" @onclick='()=>ChangeQueryTab("instructor")' id="course-pills-tab-2" data-bs-toggle="pill" data-bs-target="#course-pills-2" type="button" role="tab" aria-controls="course-pills-2" aria-selected="false">Instruktor</button>
							</li>
							<li class="nav-item me-2 me-sm-4" role="presentation">
								<button class="nav-link mb-2 mb-md-0 @tabs[2].ToString()" @onclick='()=>ChangeQueryTab("register")' id="course-pills-tab-3" data-bs-toggle="pill" data-bs-target="#course-pills-3" type="button" role="tab" aria-controls="course-pills-3" aria-selected="false">Ro'yxatdan o'tish</button>
							</li>
							<!-- Tab item -->
							
						</ul>
					</div>
					<!-- Tabs END -->

					<!-- Tab contents START -->
					<div class="card-body p-4">
						<div class="tab-content pt-2" id="course-pills-tabContent">
							<!-- Content START -->
							<div class="tab-pane @tabs[0].ToString()" id="course-pills-1" role="tabpanel" aria-labelledby="course-pills-tab-1">
								<!-- Course detail START -->
								
								<h5 class="mb-3">Kurs haqida</h5>
								<p class="mb-3"><strong>@course.Title</strong> kursiga xush kelibsiz!</p>
								<p class="mb-3">@course.Description</p>
								
								<!-- List content -->
								<h5 class="mt-4">Nimalarni o'rganasiz?</h5>
								<div class="row mb-3">
									<div class="col-md-6">
										<ul class="list-group list-group-borderless">
											@for(int i = 0; i <course.Themes.Count - course.Themes.Count/2; i++)
											{
												<li class="list-group-item h6 fw-light d-flex mb-0"><i class="fas fa-check-circle text-success me-2"></i>@course.Themes[i]</li>
											}
										</ul>
									</div>

									<div class="col-md-6">
										<ul class="list-group list-group-borderless">
											@for(int i = course.Themes.Count - course.Themes.Count/2; i < course.Themes.Count; i++)
											{
												<li class="list-group-item h6 fw-light d-flex mb-0"><i class="fas fa-check-circle text-success me-2"></i> @course.Themes[i]</li>
											}
										</ul>
									</div>
								</div>

								<p class="mb-0">Bizga qo'shilishni istaysizmi? Unday bo'lsa <strong>@course.Title</strong> kursi uchun hoziroq ro'yxatdan o'ting va biz bilan yuqori marralarni zabt eting!</p>
								<!-- Course detail END -->
							</div>
							
							<!-- Content START -->
							<div class="tab-pane mx-4 @tabs[1].ToString()" id="course-pills-2" role="tabpanel" aria-labelledby="course-pills-tab-2">
								<!-- Card START -->
								<div class="card mb-0 ">
									<div class="row g-0 align-items-center">
										<div class="col-md-5 mb-4">
											<!-- Image -->
											<img src="/assets/images/avatar/@instructor.BannerId" class="img-fluid rounded-3" alt="instructor-image" >
										</div>
										<div class="col-md-7 mb-4">
											<!-- Card body -->
											<div class="card-body ">
												<!-- Title -->
												<h3 class="card-title mb-0 ">@instructor.InstructorName</h3>
												<p class="mb-2">@instructor.MentorWorkPlace</p>
												<!-- Social button -->
												<ul class="list-inline mb-3">
													<li class="list-inline-item me-3">
														<a href="@instructor.TwitterUrl" class="fs-5 text-twitter"><i class="fab fa-twitter"></i></a>
													</li>
													<li class="list-inline-item me-3">
														<a href="@instructor.InstagramUrl" class="fs-5 text-instagram"><i class="fab fa-instagram"></i></a>
													</li>
													<li class="list-inline-item me-3">
														<a href="@instructor.FacebookUrl" class="fs-5 text-facebook"><i class="fab fa-facebook"></i></a>
													</li>
													<li class="list-inline-item me-3">
														<a href="@instructor.LinkedInUrl" class="fs-5 text-linkedin"><i class="fab fa-linkedin"></i></a>
													</li>
													<li class="list-inline-item">
														<a href="@instructor.TelegramUrl" class="fs-5 text-telegram"><i class="fab fa-telegram"></i></a>
													</li>
												</ul>

												<!-- Info -->
												<ul class="list-inline">
													<li class="list-inline-item">
														<div class="d-flex align-items-center me-3 mb-2">
															<span class="icon-md bg-orange bg-opacity-10 text-orange rounded-circle"><i class="fas fa-user-graduate"></i></span>
															<span class="h6 fw-light mb-0 ms-2"><strong>@instructor.StudentCount</strong>+ bitiruvchilar</span>
														</div>
													</li>
													<li class="list-inline-item">
														<div class="d-flex align-items-center me-3 mb-2">
															<span class="icon-md bg-warning bg-opacity-10 text-warning rounded-circle"><i class="fas fa-play"></i></span>
															<span class="h6 fw-light mb-0 ms-2"><strong>@courses.Count()</strong> Kurslar </span>
														</div>
													</li>
													<li class="list-inline-item">
														<div class="d-flex align-items-center me-3 mb-2">
															<span class="icon-md bg-warning bg-opacity-10 text-warning rounded-circle"><i class="fas fa-star"></i></span>
															<span class="h6 fw-light mb-0 ms-2"><strong>@instructor.Experience</strong>+ yillik tajriba </span>
														</div>
													</li>
												</ul>
												<div class="d-flex align-items-center ">
													<span class="icon-md text-dark mb-0 bg-light rounded-3"><i class="fas fa-graduation-cap"></i></span>
													<div class="ms-3">
														<h6 class="mb-0">Sejong Universiteti</h6>
														<p class="mb-0 small">Axborot texnologiyalari</p>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- Instructor info -->
								@* <h5 class="">Instruktor haqida</h5>
								<p class="mb-3">@instructor.AboutInstructor</p> *@
								<div class="row">
									<div class="col-12">
										<div class="card border bg-transparent rounded-3 ">
											<!-- Card header START -->
											<div class="card-header bg-transparent border-bottom ">
												<h4 class="mb-2 mb-sm-0 text-center">Boshqa kurslar</h4	>
											</div>
											<div class="card-body">
												<div class="table-responsive-lg border-0 rounded-3">
													<table class="table table-dark-gray align-middle p-4 mb-0">
														<thead>
															<tr>
																<th scope="col" class="border-0 rounded-start text-center">Kurs nomi</th>
																<th scope="col" class="border-0 text-center">Narx</th>
																<th scope="col" class="border-0 text-center">Davomiyligi</th>
																<th scope="col" class="border-0 rounded-end text-center">Ro'yxatdan o'tish</th>
															</tr>
														</thead>
														@{
															var format = CultureInfo.CreateSpecificCulture("uz-Latn-Uz").NumberFormat;
															format.CurrencyPositivePattern = 3;
														}
														<tbody>
															@foreach(Course courseItem in PaginatedCourses)
															{
																<tr>
																	<td>
																		<a type="button" @onclick='()=>NavigateToCourse(courseItem.Title, string.Empty)'>
																			<div class="d-flex align-items-center">
																				<div class="w-100px w-md-60px">
																					<img src="assets/images/courses/@courseItem.BannerId" class="rounded" alt="">
																				</div>
																				<h6 class="mb-0 ms-2">	
																					<a type="button">@courseItem.Title</a>
																				</h6>
																			</div>
																		</a>
																	</td>
																	<td class="text-center"><strong>@courseItem.CostInUzs.ToString("C0", format)</strong></td>
																	<td class="text-center">
																		<span class="badge bg-primary bg-opacity-10 text-primary"><strong>@courseItem.CourseDuration</strong> oy</span>
																	</td>
																	<td class="text-center">
																		<a type="button" @onclick='()=>NavigateToCourse(courseItem.Title, "register")' class="btn btn-sm btn-success-soft btn-round me-1 mb-0"><i class="far fa-fw fa-edit"></i></a>
																	</td>
																</tr>
															}
														</tbody>
													</table>
												</div>

												<!-- Pagination -->
												<div class="d-sm-flex align-items-sm-center mt-3">
													<ul class="pagination pagination-sm pagination-primary-soft mb-0 pb-0" style="margin: auto;">
														<li class="page-item mb-0"><a class="page-link" type="button" @onclick='()=>GetPaginatedCourses(-1)' tabindex="-1"><i class="fas fa-angle-left"></i></a></li>
														@for(int i = 1; i <= (courses.Count()+2)/3;i++)
														{
															var page = i;
															if(i == paginatedCount){
																<li class="page-item mb-0 active"><button class="page-link" type="button" @onclick="(()=>GetPaginatedCourses(page))">@i</button></li>
															}
															else{
																<li class="page-item mb-0"><button class="page-link" type="button" @onclick='(()=>GetPaginatedCourses(page))'>@i</button></li>
															}
														}
														<li class="page-item mb-0 "><button class="page-link" @onclick='()=>GetPaginatedCourses(0)'><i class="fas fa-angle-right"></i></button></li>
													</ul>
												</div>
											</div>
											<!-- Card body START -->
										</div>
									</div>
								</div>
							</div>
							<div class="tab-pane @tabs[2].ToString()" id="course-pills-3" role="tabpanel" aria-labelledby="course-pills-tab-3">
								<p class="fw-bold">Ro'yxatdan o'tganingizdan so'ng operatorlar siz bilan aloqaga chiqishadi.</p>
								<div class="row g-3 mt-0">
									<div class="col-md-6">
										<img src="/assets/images/element/reg.png" style="background-color: blue;border-radius:7%;">
									</div>
										<div class="col-md-6 bg-light-input">
											<form name="register-form" id="register-form">
													<label for="name" class="form-label">Ismingiz *</label>
													<input type="text" name="Name" class="form-control" id="name" required>
													<label for="phone" class="form-label mt-2">Telefon raqamingiz *</label><br>
													<input type="tel" name="Phone" class="form-control" id="phone"><br>
													<label for="message" class="form-label mt-2">Xabar</label>
													<input hidden name="Course" value="@course.Title" id="course">
													<textarea type="text" name="Message" rows="4" class="form-control" id="message"></textarea>
													<label for="CourseType" class="form-label mt-2">Kurs formati *</label>
													<select class="form-select" name="Format" id="CourseType" required>
														<option value="Offline">Offline</option>
														<option value="Online">Online</option>
													</select>
													<input hidden value="@time.ToString()" name="Date">
											</form>
										</div>
									<div class="text-center">
										<button class="btn btn-lg btn-success mt-3 mb-0" id="SendButton" onclick="Send_Data('@connection.RegisterConnection', 'register-form')" type="submit">Ro'yxatdan o'tish</button>
									</div>	
									<div class="mt-3" id="form_alerts"></div>
								</div>
							</div>
						</div>
					</div>
					<!-- Tab contents END -->
				</div>
			</div>
			<!-- Main content END -->
			<!-- Right sidebar START -->
			<div class="col-lg-4 pt-5 pt-lg-0">
				<div class="row mb-5 mb-lg-0">
					<div class="col-md-6 col-lg-12">
						<!-- Video START -->
						<div class="card shadow p-2 mb-4 mb-4 z-index-9">
							<div class="overflow-hidden rounded-3">
								<img src="/assets/images/courses/@course.BannerId" class="card-img" alt="@course.BannerId">
							</div>
		
							<!-- Card body -->
							<div class="card-body px-3">
								<!-- Info -->
								
								<div class="d-flex justify-content-between align-items-center">
									<div class="d-flex align-items-center">
										<span class="icon-md bg-warning bg-opacity-15 text-warning rounded-circle"><i class="fas fa-chalkboard-teacher"></i></span><span class="fw-bold">&nbspOffline:</span>
										<h5 class="fw-bold mb-0 mx-2">@course.CostInUzs.ToString("C0", format)</h5>
									</div>
									<div class="dropdown">
										<!-- Share button -->
										<a class="btn btn-sm btn-light rounded small" id="dropdownShare" data-bs-toggle="dropdown" >
											<i class="fas fa-fw fa-share-alt"></i>
										</a>
										<!-- dropdown button -->
										<ul class="dropdown-menu dropdown-w-sm dropdown-menu-end min-w-auto shadow rounded" aria-labelledby="dropdownShare">
											<li><a class="dropdown-item" type="button" onclick="window.open('https://t.me/share/url?url='+location.href.toString()+'?tab=@tab.ToString()')"><i class="fab fa-telegram me-2"></i>Telegram</a></li>
											<li><a class="dropdown-item" type="button" onclick="window.open('http://www.facebook.com/share.php?u='+location.href.toString()+'?tab=@tab.ToString()')"><i class="fab fa-facebook-square me-2"></i>Facebook</a></li>
											<li><a class="dropdown-item" type="button" onclick="window.open('https://www.linkedin.com/sharing/share-offsite/?url='+location.href.toString()+'?tab=@tab.ToString()')"><i class="fab fa-linkedin me-2"></i>LinkedIn</a></li>
											<li ><a class="dropdown-item" type="button" onclick="navigator.clipboard.writeText(window.location.href.toString()+'?tab=@tab.ToString()')"><i class="fas fa-copy me-2"></i>Copy link</a></li>
										</ul>
									</div>
								</div>
								<div class="d-flex justify-content-between align-items-center mt-1">
									<div class="d-flex align-items-center">
										<span class="icon-md bg-warning bg-opacity-15 text-warning rounded-circle"><i class="fas fa-globe"></i></span><span class="fw-bold">&nbspOnline:</span>
										<h5 class="fw-bold mb-0 mx-2">@course.OnlineCourseCost.ToString("C0", format)</h5>
									</div>
									<div>
										<span class="badge bg-orange text-white mb-0 " style="align-content: right;">-@Discount%</span>
									</div>
								</div>
								
							</div>
						</div>

						<!-- Course info START -->
						<div class="card card-body shadow p-4 mb-4">
							<!-- Title -->
							<ul class="list-group list-group-borderless">
								<li class="list-group-item d-flex justify-content-between align-items-center">
									<span class="h6 fw-light mb-0"><i class="fas fa-fw fa-book-open text-primary"></i>Kurs davomiyligi</span>
									<span>@course.CourseDuration oy</span>
								</li>
								<li class="list-group-item d-flex justify-content-between align-items-center">
									<span class="h6 fw-light mb-0"><i class="fas fa-calendar-week text-primary"></i> Haftadagi darslar soni</span>
									<span>@course.WeekDuration</span>
								</li>
								<li class="list-group-item d-flex justify-content-between align-items-center">
									<span class="h6 fw-light mb-0"><i class="fas fa-fw fa-clock text-primary"></i>Dars davomiyligi </span>
									<span>@course.ClassDuration soat</span>
								</li>
								<li class="list-group-item d-flex justify-content-between align-items-center">
									<span class="h6 fw-light mb-0"><i class="fas fa-fw fa-signal text-primary"></i>Daraja</span>
									<span>@course.CourseLevel</span>
								</li>
								<li class="list-group-item d-flex justify-content-between align-items-center">
									<span class="h6 fw-light mb-0"><i class="fas fa-fw fa-globe text-primary"></i>Til</span>
									<span>O'zbek</span>
								</li>
								<li class="list-group-item d-flex justify-content-between align-items-center">
									<span class="h6 fw-light mb-0"><i class="fas fa-fw fa-user-clock text-primary"></i>Deadline</span>
									<span>@course.Deadline</span>
								</li>
								<li class="list-group-item d-flex justify-content-between align-items-center">
									<span class="h6 fw-light mb-0"><i class="fas fa-fw fa-medal text-primary"></i>Sertifikat</span>
									<span>Ha</span>
								</li>
							</ul>
						</div>
						<!-- Course info END -->
					</div>
				</div><!-- Row End -->
			</div>
			<!-- Right sidebar END -->
		</div><!-- Row END -->
	</div>
</section>
</main>

@code{
	[Parameter]
	public string CourseTitle { get; set; } = "";
	[Inject]
    public HttpClient Http { get; set; }
	private Course course = new Course(){Themes=new()};
	private Instructor instructor = new();
	private static byte Discount = 0;
	private static List<Course> courses = new();
	private static List<Course> PaginatedCourses = new();
	private Connection connection = new();
	private int paginatedCount = 1;
	private StringBuilder tab = new StringBuilder("");
	private StringBuilder time = new StringBuilder(DateTime.Now.ToString("ddd, dd MMM, HH':'mm, yyyy "));
	private List<StringBuilder> tabs = new List<StringBuilder>(){new("active"), new(), new()};
	protected override async Task OnInitializedAsync()
	{
		course = (await Http.GetFromJsonAsync<List<Course>>("data/courses.json"))
			.Where(c => c.Title==CourseTitle).FirstOrDefault();
		Discount = (byte)((1 - (double)course.OnlineCourseCost/(double)course.CostInUzs)*100);
		courses = (await Http.GetFromJsonAsync<List<Course>>("data/courses.json"))
			.Where(c => c.InstructorName == course.InstructorName && c.Title!=course.Title).ToList();
		connection = await Http.GetFromJsonAsync<Connection>("credential.json");
		instructor = (await Http.GetFromJsonAsync<List<Instructor>>("data/instructors.json"))
			.Where(c => c.InstructorName == course.InstructorName).FirstOrDefault();
		PaginatedCourses = courses.Skip(0).Take(3).ToList();
		await jsRuntime.InvokeVoidAsync("PhoneValidation");
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("tab", out var param))
        {
            tab = new StringBuilder(param);
        }

		if(tab.ToString()=="register")
		{
			tabs[2] = new("active");
			tabs[0].Clear();
			tabs[1].Clear();
		}
		else if(tab.ToString() == "instructor")
		{
			tabs[2].Clear();
			tabs[0].Clear();
			tabs[1] = new("active");
		}
	}

	private void ChangeQueryTab(string active)
	{
		tab = new StringBuilder(active);
	}

	private void NavigateToCourse(string Url, string tab1)
	{
		NavigationManager.NavigateTo($"/coursedetail/{Url}?tab={tab1}", forceLoad:true);
	}

	private void GetPaginatedCourses(int page)
	{
		if(page==0)
		{
			paginatedCount = paginatedCount+1 <= (courses.Count()+2)/3?++paginatedCount:paginatedCount;
		}
		else if(page==-1)
		{
			paginatedCount = paginatedCount > 1?--paginatedCount:paginatedCount;
		}
		else
		{
			paginatedCount = page;
		}
		PaginatedCourses = courses.Skip((paginatedCount-1)*3).Take(3).ToList();
	}
}